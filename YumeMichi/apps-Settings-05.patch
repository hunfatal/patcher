From 5fd283b6402a888d58b529f963bda1d68fa214bd Mon Sep 17 00:00:00 2001
From: maxwen <max.weninger@gmail.com>
Date: Sat, 14 Apr 2018 00:09:09 +0200
Subject: [PATCH] [2/2] Settings: Add progress for font apply

Change-Id: I12312f3a7859a4244387f5183a3d938bffb5b83f
---
 res/values/custom_strings.xml                 |  1 +
 src/com/android/settings/DisplaySettings.java | 43 ++++++++++++++++++-
 .../display/FontDialogPreference.java         | 24 +++++++++++
 .../FontPickerPreferenceController.java       | 10 +----
 4 files changed, 69 insertions(+), 9 deletions(-)

diff --git a/res/values/custom_strings.xml b/res/values/custom_strings.xml
index 8ebfb7983f..b76e8d88c4 100644
--- a/res/values/custom_strings.xml
+++ b/res/values/custom_strings.xml
@@ -20,4 +20,5 @@
 <resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
     <!-- Font picker -->
     <string name="font_picker_title">Font</string>
+    <string name="font_picker_progress">Setting font\u2026</string>
 </resources>
diff --git a/src/com/android/settings/DisplaySettings.java b/src/com/android/settings/DisplaySettings.java
index 43a61f58bf..d2fa7904d9 100644
--- a/src/com/android/settings/DisplaySettings.java
+++ b/src/com/android/settings/DisplaySettings.java
@@ -16,8 +16,13 @@
 
 package com.android.settings;
 
+import android.content.BroadcastReceiver;
 import android.content.Context;
+import android.content.Intent;
+import android.content.IntentFilter;
+import android.os.Bundle;
 import android.provider.SearchIndexableResource;
+import android.util.Log;
 
 import com.android.internal.hardware.AmbientDisplayConfiguration;
 import com.android.internal.logging.nano.MetricsProto.MetricsEvent;
@@ -57,6 +62,42 @@ public class DisplaySettings extends DashboardFragment {
     private static final String KEY_SCREEN_TIMEOUT = "screen_timeout";
     private static final String KEY_AMBIENT_DISPLAY = "ambient_display";
 
+    private IntentFilter mIntentFilter;
+    private static FontPickerPreferenceController mFontPickerPreference;
+
+    private BroadcastReceiver mIntentReceiver = new BroadcastReceiver() {
+        @Override
+        public void onReceive(Context context, Intent intent) {
+            String action = intent.getAction();
+            if (action.equals("com.android.server.ACTION_FONT_CHANGED")) {
+                Log.d(TAG, "onReceive " + action);
+                mFontPickerPreference.stopProgress();
+            }
+        }
+    };
+
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        mIntentFilter = new IntentFilter();
+        mIntentFilter.addAction("com.android.server.ACTION_FONT_CHANGED");
+    }
+
+    @Override
+    public void onResume() {
+        super.onResume();
+        final Context context = getActivity();
+        context.registerReceiver(mIntentReceiver, mIntentFilter);
+    }
+
+    @Override
+    public void onPause() {
+        super.onPause();
+        final Context context = getActivity();
+        context.unregisterReceiver(mIntentReceiver);
+        mFontPickerPreference.stopProgress();
+    }
+
     @Override
     public int getMetricsCategory() {
         return MetricsEvent.DISPLAY;
@@ -91,7 +132,7 @@ public class DisplaySettings extends DashboardFragment {
     private static List<AbstractPreferenceController> buildPreferenceControllers(
             Context context, Lifecycle lifecycle) {
         final List<AbstractPreferenceController> controllers = new ArrayList<>();
-        controllers.add(new FontPickerPreferenceController(context, lifecycle));
+        controllers.add(mFontPickerPreference = new FontPickerPreferenceController(context, lifecycle));
         controllers.add(new AutoBrightnessPreferenceController(context, KEY_AUTO_BRIGHTNESS));
         // controllers.add(new AutoRotatePreferenceController(context, lifecycle));
         controllers.add(new CameraGesturePreferenceController(context));
diff --git a/src/com/android/settings/display/FontDialogPreference.java b/src/com/android/settings/display/FontDialogPreference.java
index d5d8dffbf2..6d8dc19503 100644
--- a/src/com/android/settings/display/FontDialogPreference.java
+++ b/src/com/android/settings/display/FontDialogPreference.java
@@ -21,6 +21,7 @@ package com.android.settings.display;
 import com.android.settingslib.CustomDialogPreference;
 
 import android.app.AlertDialog.Builder;
+import android.app.ProgressDialog;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.FontInfo;
@@ -36,6 +37,7 @@ public class FontDialogPreference extends CustomDialogPreference {
     private static final String TAG = "FontDialogPreference";
     private Context mContext;
     private IFontService mFontService;
+    private ProgressDialog mProgressDialog;
 
     public FontDialogPreference(Context context, AttributeSet attrs) {
         super(context, attrs);
@@ -54,8 +56,10 @@ public class FontDialogPreference extends CustomDialogPreference {
             public void onClick(DialogInterface dialog, int which) {
                 FontInfo info = adapter.getItem(which);
                 try {
+                    startProgress();
                     mFontService.applyFont(info);
                 } catch (RemoteException e) {
+                    stopProgress();
                 }
             }
         };
@@ -72,4 +76,24 @@ public class FontDialogPreference extends CustomDialogPreference {
             dialog.dismiss();
         }
     }
+
+    private void startProgress() {
+        if(mProgressDialog != null) {
+            stopProgress();
+        }
+        mProgressDialog = new ProgressDialog(mContext);
+        mProgressDialog.setIndeterminate(true);
+        mProgressDialog.setTitle(mContext.getString(R.string.font_picker_title));
+        mProgressDialog.setMessage(mContext.getString(R.string.font_picker_progress));
+        mProgressDialog.setCancelable(false);
+        mProgressDialog.setCanceledOnTouchOutside(false);
+        mProgressDialog.show();
+    }
+
+    public void stopProgress() {
+        if (mProgressDialog != null) {
+            mProgressDialog.dismiss();
+            mProgressDialog = null;
+        }
+    }
 }
diff --git a/src/com/android/settings/display/FontPickerPreferenceController.java b/src/com/android/settings/display/FontPickerPreferenceController.java
index a25eacbd3c..3b0c6cfbdc 100644
--- a/src/com/android/settings/display/FontPickerPreferenceController.java
+++ b/src/com/android/settings/display/FontPickerPreferenceController.java
@@ -92,13 +92,7 @@ public class FontPickerPreferenceController extends AbstractPreferenceController
         }
     }
 
-    private boolean isPackageInstalled(String package_name, Context context) {
-        try {
-            PackageManager pm = context.getPackageManager();
-            pm.getPackageInfo(package_name, PackageManager.GET_ACTIVITIES);
-            return true;
-        } catch (Exception e) {
-            return false;
-        }
+    public void stopProgress() {
+        mFontPreference.stopProgress();
     }
 }
-- 
2.17.0

